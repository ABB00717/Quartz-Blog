---
title: 05 Control Plane
draft: true
tags:
  - computer-networks
date: 2025-12-06
---
上一章節的資料平面（data plane）在講的只是路由器如何把封包從輸入孔搬到輸出孔。而控制平面（control plane）講的則是路由器如何知道封包要往哪裡搬，簡單來說，就是決定路徑，而產物就是上一章的轉送表（forwarding table）。控制平面算出結果，導入轉送表，資料平面再照著做事。

主要要解決的問題有兩個：
1. 如何計算從 A 到 B 的最短路徑？
2. 如果中間有節點掛了，全網路該如何自動更新？

控制平面可分為兩種：
1. 每路由器控制（per-router control）
2. 邏輯集中式控制（logically centralized）：現在的流行
# 大綱
- 傳統路由演算法
- 路由通訊協定
	- OSPF
	- BGP
- SDN
- 管理工具
# 路由演算法
封包發送時，都必須明確定義路由器序列。目的很明確：找出來源和目的地之間成本最低的路徑。

現在給你一張圖 $E$
![[assets/image.png]]
如果可以和我們現在一樣清楚看到每個節點、路徑的資料，那就是**集中式的路由演算法**。所以該演算法會將所有節點之間的連通性與所有鏈路成本作為輸入。因此在計算之前，必須先以某種方式拿到這些完整的資料，在哪裡計算其實無所謂。像這種有全域狀態資訊的演算法通常被稱為鏈路狀態（Link State）演算法。

透過和鄰近路由交換資訊的迭代過程中慢慢算出來的，就叫**分散式路由演算法**。又稱為距離向量（Distance Vector）演算法，因為每個節點會維護一個包含其他節點成本估計值的向量。

另外還可以通過靜態與動態（調整路由路徑）、負載敏感與不敏感（估計擁塞程度決定是否繞行）來分類演算法。

## 鏈路狀態路由演算法
此演算法中，已知所有網路拓撲與鏈路成本，通過和其他節點廣播鏈路狀態封包可以實現。鏈路狀態路由演算法常見的有 Dijkstra 和 Prim 演算法。鏈路成本等於流量負載。

> 計算路徑還是在每個路由器上算，只是轉送表資料是全域共享的。

[[22 single-source shortest paths#Dijkstra 演算法| 詳細請見演算法單向圖章節]]

![[assets/image-2.png]]

如果所有路由器都在同一時間同步的話，可能會出現異常。假設只有 $A$ 和 $B$ 兩條路徑，$d(A) = 0, d(B) = N$，那所有路由同時同步的結果就是所有路由同時轉向 $A$，變成$d(A) = N, d(B) = 0$，$B$ 變得完全沒有流量，下次同步又會同時轉向 $B$。此異常稱為震盪。

解決方法很簡單，就是不要讓他們同時同步。相同週期不同時間點執行以被發現無效，解決方法之一就是讓每台路由器隨機發送鏈路通告的時間。
## 距離向量路由演算法
鏈路狀態演算法使用全域資訊，而距離向量演算法則是迭代且分散式的，每個節點從一個或多個鄰居接收資訊，計算後再傳給鄰居，直到不再交換訊息為止（它會自我中止！）。以 Bellman-Ford 的概念最為重要。

[[22 single-source shortest paths#Bellman-Ford| 詳細請見演算法單向圖章節]]

![[image-1.png]]

節點 $n$ 剛開始只放自己 $n$ 第一步的初始資料，之後接收到全部鄰居節點的資料後，開始更新第二步。就這樣一直蒐集、更新、擴散，過程會持續到沒有更新訊息為止。

類似距離向量的演算法在實際中應用於許多路由協定，包括網際網路的 RIP 和 BGP、ISO 
IDRP、Novell IPX 以及原始的 ARPAnet。

> 迴圈與震盪的討論

如果有一條線路斷了

B: 去D找A
A -> D 斷了
但B還不知道，所以它這時若和A說「我要去D」（因為他以為A還能到D），如果B也可以去D，那這個資訊就會更新給A，所以A的表就會更新說：「如果要去D就找B」，所以就又會把封包丟回去給B。然而這時若許A還沒和B更新轉送表，所以B又會把封包丟回去給A。就這樣一直反覆直到計數到無限。

# 通訊協定
整個互連網有成上百億個裝置，若每個裝置都必須直接互連路由表肯定膨脹。因此我們需要把整塊網路切成很多個小圈圈，這方法叫做階層式路由，而這些圈圈就叫做自治系統（Autonomous Systems）。也因此會有對內與對外的不同協定。

## OSPF（Open Shortest Path First）
- 對內溝通的協定（Intra-AS）。
- 因為系統內裝置數量少，不會狀態爆炸，可以使用集中式演算法。

> [!question] 那具體來說是什麼？

## BGP（Border Gateway Protocol）
- 對外溝通的協定（Inter-AS），負責自治系統之間的路由（Inter-AS）
- 每個自治系統都有自己的邊界路由器（Gateway Router），代表與外面的自治系統溝通

> [!question] 那具體來說是什麼？

邊界路由器要有兩大特點。一個是他要能夠翻譯不同的協定，另一個是路由反射。假設一個非邊界路由器的一般路由器 $A$ 要傳訊息給另外一個 $B$，那 $B$ 不能幫 $A$ 代傳。然而如果 $A$ 是告訴邊界路由器，它就會反射給其他的所有路由器。所以大家只要和它連線就好。

> BGP Hijacking

# SDN（Software Defined Networking）
以前每個路由器都要自己算路徑（分散式），現在則是偏向集中式，把所有路徑計算都放一台控制器（Controller）上統一管理。

> 只要攻下一台控制器就可以控制整個網路

# 管理工具
- ICMP：提供網路狀況反饋
	- 在網路層
- SNMP：監控和管理網路裝置，包括和資料庫（MIB）和代理程式（Agent）的互動
	- 在應用層

> ICMP Tunneling

> SNMP 列舉

---
# 參考資料
1. Computer Networking: a Top Down Approach