---
title: 死結預防
draft: false
tags:
  - operating-system
  - deadlock
date: 2025-12-10
---

**死結預防**是一組靜態的資源分配策略，其核心目標是確保死結發生的四個必要條件（互斥、持有並等待、不可搶佔、循環等待）中，**至少有一個條件在系統中永遠無法成立** 。

以下針對四個條件逐一說明預防機制：

## 互斥 (Mutual Exclusion)

此條件要求資源在同一時間只能被一個行程使用。

* **機制**：將資源設計為可共享（Sharable）。對於唯讀（Read-only）檔案等可共享資源，無需互斥存取，因此不會發生死結 。
* **限制**：此方法在實務上受到嚴格限制。許多資源在本質上是**不可共享的（Nonsharable）**，例如印表機或互斥鎖（Mutex locks）。對於這些資源，互斥條件必須成立 。
* **結論**：無法透過否定互斥條件來預防所有類型的死結。

## 持有並等待 (Hold and Wait)

此條件指一個行程在持有部分資源的同時，請求其他資源。預防策略是確保當行程請求資源時，它未持有任何其他資源 。

* **策略一（一次性請求）**：要求行程在開始執行之前，必須一次性請求並獲分配所有需要的資源 。
* **策略二（釋放後請求）**：允許行程請求資源，但前提是該行程目前沒有持有任何資源（即在請求新資源前，必須釋放當前持有的所有資源） 。
* **缺點**：
    1.  **資源利用率低 (Low resource utilization)**：行程可能長期佔用它僅在執行末期才需要的資源 。
    2.  **飢餓 (Starvation)**：若行程需要多個常用資源，可能因為無法同時獲得所有資源而無限期等待 。

## 不可搶佔 (No Preemption)

此條件指資源不能被強制從行程中移除。預防策略是允許系統強制剝奪行程已獲得的資源。

* **機制**：
    * 若一個持有資源的行程請求另一個無法立即獲得的資源（即需要等待），則該行程目前持有的**所有資源都將被搶佔（Preempted）** 。
    * 這些被搶佔的資源會被釋放，並加入到該行程正在等待的資源列表中 。
    * 該行程只有在重新獲得其舊有資源以及新請求的資源後，才能重新開始執行 。
* **替代場景**：若請求的資源被另一個「正在等待額外資源」的行程持有，則可以搶佔該等待行程的資源給當前請求者 。
* **適用性**：此方法通常僅適用於狀態易於保存與恢復（Saved and Restored）的資源，例如 CPU 暫存器（Registers）與記憶體空間。對於印表機或磁帶機等硬體設備通常不適用 。

## 循環等待 (Circular Wait)

此條件指存在一個行程的環狀鏈，互相等待資源。這是最常見的預防途徑。

* **機制**：對系統中所有資源類型進行**全序排序 (Total Ordering)** 。
    * 為每個資源類型 $R$ 分配一個唯一的整數 $F(R)$。
    * 例如：$F(\text{Tape}) = 1, F(\text{Disk}) = 5, F(\text{Printer}) = 12$。
* **協議**：
    * 行程可以請求資源，但必須嚴格按照**遞增順序**請求。
    * 若行程已持有資源 $R_i$，則它只能請求 $F(R_j) > F(R_i)$ 的資源 $R_j$ 。
    * 例如：若行程持有磁碟（優先級 4），它可以請求印表機（優先級 8），但不能回頭請求磁帶（優先級 2） 。
    * 若需請求低優先級資源，必須先釋放所有高優先級資源 。
* **證明**：透過數學歸納法可證明，若嚴格遵守資源有序分配，資源分配圖（Resource Allocation Graph）中不可能形成循環（Cycle）。