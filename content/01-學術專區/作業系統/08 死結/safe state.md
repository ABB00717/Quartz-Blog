---
title: 安全狀態（Safe State）
draft: false
tags:
  - operating-system
  - deadlock
date: 2025-12-10
---

在作業系統的死結避免機制中，**安全狀態**是一個核心概念。當行程請求一個可用資源時，系統必須判斷：若立即分配該資源，系統是否仍會處於安全狀態？如果會，則允許分配；否則，該行程必須等待。

## 1. 定義

若系統存在一個**安全序列 (Safe Sequence)**，則稱該系統處於**安全狀態** 。

所謂安全序列，是指由系統中所有行程 $<P_1, P_2, ..., P_n>$ 組成的一個特定排列順序，使得對於每個行程 $P_i$，其未來所需的資源請求量（最大需求減去目前持有量）皆能被滿足，滿足的來源包含：
1.  **目前系統中可用的資源 (Available Resources)**。
2.  **所有排在 $P_i$ 之前的行程 ($P_j, j < i$) 當前所持有的資源** 。

> 如果在前面的行程不能在未來請求編號在其以後的行程持有的資源，那有可能會有死結（循環等待），所以不該分配這個資源。

## 2. 安全序列的運作邏輯

安全序列的存在保證了所有行程都能依序完成執行，其邏輯推演如下：

1.  **等待 (Wait)**：若行程 $P_i$ 所需的資源無法由「目前可用資源」立即滿足，則 $P_i$ 可以等待，直到所有排在它之前的行程 $P_j (j < i)$ 完成執行 。
2.  **釋放與執行 (Release and Execute)**：當前置行程 $P_j$ 完成任務後，它會釋放其持有的所有資源。這些釋放的資源加上原有的可用資源，將足夠滿足 $P_i$ 的需求 。
3.  **終止 (Terminate)**：$P_i$ 獲得資源、執行、釋放資源並終止後，接著便能滿足序列中下一個行程 $P_{i+1}$ 的需求 。

若能找到這樣一個順序，系統便能保證不會發生死結。

## 3. 安全狀態與不安全狀態的關係

* **安全狀態 (Safe State)**：若系統處於安全狀態，則**絕無死結 (No Deadlocks)** 。
* **不安全狀態 (Unsafe State)**：若系統找不到任何一個安全序列，則稱系統處於不安全狀態。
    * 不安全狀態並不等於死結，但它隱含了**死結的可能性 (Possibility of Deadlock)** 。
    * 一旦進入不安全狀態，系統無法保證能阻止行程提出導致死結的資源請求。
* **死結避免策略**：死結避免演算法（如銀行家演算法）的目標，即是確保系統狀態始終保持在安全狀態，永遠不進入不安全狀態 。

## 4. 實例推演

以下使用磁帶機（Tape Drives）的資源分配案例來說明安全與不安全狀態的差異。系統共有 12 台磁帶機 。

### 4.1 安全狀態範例

假設時間點 $t_0$ 的資源分配狀態如下 ：
* **總資源**：12
* **目前已分配**：$5 (A) + 2 (B) + 2 (C) = 9$
* **目前可用 (Available)**：$12 - 9 = 3$

| 行程 | 最大需求 (Max) | 目前持有 (Holding) | 尚需 (Needs) |
| :--- | :--- | :--- | :--- |
| **A** | 10 | 5 | 5 |
| **B** | 4 | 2 | 2 |
| **C** | 9 | 2 | 7 |

**分析**：序列 $<B, A, C>$ 是一個安全序列 。
1.  **B** 的尚需資源 (2) $\le$ 目前可用 (3)。B 執行並釋放其持有的 2 台（加上原本分配給它的 2 台，共歸還 4 台）。
    * **新可用資源**：$3 - 2 + 4 = 5$ 。
2.  **A** 的尚需資源 (5) $\le$ 目前可用 (5)。A 執行並釋放其持有的 10 台。
    * **新可用資源**：$5 - 5 + 10 = 10$ 。
3.  **C** 的尚需資源 (7) $\le$ 目前可用 (10)。C 執行。
    * 所有行程皆可完成，系統處於**安全狀態** 。

### 4.2 不安全狀態範例

承上例，若在 $t_0$ 時，行程 C 多請求並獲得了 1 台磁帶機，狀態變更如下 ：
* **目前已分配**：$5 (A) + 2 (B) + 3 (C) = 10$
* **目前可用 (Available)**：$12 - 10 = 2$ 

| 行程 | 最大需求 (Max) | 目前持有 (Holding) | 尚需 (Needs) |
| :--- | :--- | :--- | :--- |
| **A** | 10 | 5 | 5 |
| **B** | 4 | 2 | 2 |
| **C** | 9 | 3 | 6 |

**分析**：
1.  目前可用資源為 2。檢查各行程需求：
    * A 需 5 (> 2)，無法執行。
    * C 需 6 (> 2)，無法執行。
    * **僅有 B** 需 2 ($\le$ 2)，可以執行。
2.  假設分配給 B，B 執行完畢後釋放其持有的 4 台。
    * **新可用資源**：4 。
3.  現在可用資源為 4：
    * A 需 5 (> 4)，仍無法執行。
    * C 需 6 (> 4)，仍無法執行。
4.  **結果**：A 與 C 皆無法獲得足夠資源，系統陷入死結。因此，允許 C 多請求 1 台磁帶機的決策讓系統進入了**不安全狀態** 。如果 A 和 C 都堅持要求達到其 Max 資源，並且不釋放手中資源，那麼死結就會發生。