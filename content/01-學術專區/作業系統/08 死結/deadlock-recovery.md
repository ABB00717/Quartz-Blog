---
title: 死結恢復
draft: false
tags:
  - operating-system
  - deadlock
date: 2025-12-10
---

當死結檢測演算法判定系統中存在死結後，作業系統必須採取措施以打破死結狀態。恢復策略主要分為兩大類：**行程終止 (Process Termination)** 與 **資源搶佔 (Resource Preemption)** 。

# 1. 行程終止 (Process Termination)

此方法透過強制終止一個或多個參與死結的行程來打破循環等待。主要有兩種執行策略：

1.  **終止所有死結行程 (Abort all deadlocked processes)**：
    * 此法最為直接，能立即消除死結循環。
    * **代價**：成本極高。這些行程可能已經運算很長一段時間，強制終止意味著這些計算成果將全部遺失，必須重新執行 。
2.  **一次終止一個行程 (Abort one process at a time)**：
    * 系統選擇一個受害者終止，然後再次執行死結檢測演算法。若死結仍存在，則繼續選擇下一個受害者，直到死結循環被消除 。
    * **代價**：系統開銷（Overhead）相當大，因為每次終止後都必須重新執行檢測演算法。

## 選擇受害者的標準 (Selection Criteria)
若採用逐一終止的策略，系統必須決定終止哪個行程能帶來**最小成本 (Minimum Cost)**。考量因素包括 ：
* **優先權 (Priority)**：優先終止優先權較低的行程。
* **執行時間**：行程已計算了多久？距離完成還需多久？
* **資源持有量**：行程目前使用了多少資源？（終止持有較多資源的行程通常能更有效地解除死結）。
* **資源需求量**：行程完成任務還需要多少資源？
* **行程類型**：是互動式（Interactive）還是批次（Batch）行程？（通常優先保留互動式行程以維持使用者體驗）。

# 2. 資源搶佔 (Resource Preemption)

此方法不直接終止行程，而是從一個或多個行程中**搶佔 (Preempt)** 資源，並將這些資源分配給其他行程，直到打破死結循環為止 。

實作資源搶佔必須處理以下三個關鍵問題：

## 2.1 選擇受害者 (Selecting a Victim)
與行程終止類似，系統必須決定搶佔哪些資源以及從哪個行程搶佔，目標是**最小化成本 (Minimize Cost)** 。成本參數可能包含行程持有的資源數量、已執行的時間等。

## 2.2 回滾 (Rollback)
當資源從行程中被搶佔後，該行程無法在缺少資源的情況下繼續執行。
* **機制**：系統必須將該行程回復到某個安全狀態，並從該狀態重新啟動 (Restart)。
* **完全回滾 (Total Rollback)**：由於要在執行中途判定「什麼是安全狀態」相當困難，最常見且簡單的做法是**終止該行程並重新啟動** 。

## 2.3 飢餓 (Starvation)
若系統總是選擇相同的行程作為受害者（因為依據成本演算法，該行程的搶佔成本始終最低），則該行程將永遠無法完成任務，導致飢餓。
* **解決方案**：在成本因素中加入**回滾次數 (Number of Rollbacks)**。確保一個行程被選為受害者的次數是有限的 。