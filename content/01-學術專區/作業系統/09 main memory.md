---
title: 09 Main Memory
draft: true
tags:
  - operating-system
date: 2025-12-06
---
# 記憶體管理

- 邏輯地址
- 實體地址
# 記憶體配置

## 連續記憶體配置
- Best-fit
- First-fit
- Second-fit
## 碎片化（Fragmentation）
- 外部碎片：有足夠的總記憶體空間，但它們不連續，無法滿足需求
- 內部碎片：分配給行程的記憶體比實際需要的稍大，多出來的部分被浪費了 。
# 分頁
把實體記憶體切成同樣大小的頁框（Frames），邏輯記憶體切成同樣大小的頁面（Pages）。讓實體地址可以是不連續的。

主要解決外部碎片的問題
## 機制
### 頁表
每一個行程都有自己的頁表。

由以下兩者組成對應的實體地址
- 虛擬頁碼 -> 實體幀號
- 偏移量

> [!question] 我們要額外為分頁分配連續的記憶體空間，而且每個行程一張頁表的話，那個大小加總起來挺可怕的。該如何解決頁表太大且連續的問題？
> 在頁表（Page Table）的結構中，通常會將其劃分為多個頁面（Page）。作業系統規定一頁的大小為 4KB，而每一頁內包含大量的分頁表項目（Page Table Entry, PTE）。PTE 的本質是一個映射項目（Entry），負責將虛擬頁碼（Virtual Page Number）對應到實體記憶體位址。將這些包含 PTE 的頁面整合起來，便形成了完整的頁表。
> 
> 然而，單層頁表的主要問題在於其體積過大且需要連續空間。若以一頁 4KB 計算，32 位元的位址空間（$2^{32}$）除以頁大小（$2^{12}$），共需要 $2^{20}$（約 100 萬）個項目。為了儲存這 100 萬個 Entry，系統需要配置一個龐大且連續的記憶體空間，這在管理上相當缺乏效率。
> 
> 為了解決這個問題，我們引入了多層頁表（Multi-level Page Table）的概念，意即「用一個頁表來管理原本的頁表」。我們將原本 20 位元的頁碼拆分為兩層：第一層 10 位元，第二層 10 位元，再加上 12 位元的偏移量（Offset）。
> 
> 在此架構下：
> 1. **第一層（外層頁表，Outer Page Table）：** 這是最外層的結構，大小為 4KB，包含 $2^{10}$（1024）個格子（Entry）。這部分必須常駐於記憶體中。
> 2. **空間優化與按需建立：** 由於行程（Process）的記憶體使用通常是離散且稀疏的（例如只使用了記憶體的最前段與最後段），我們不需要為所有 1024 個格子都分配對應的第二層頁表。
>     - 對於未使用的記憶體空間，外層頁表的對應格子可以直接指向 `Null`。
>     - 我們僅需針對實際有使用的區段（例如第一個和最後一個格子），指向有效的第二層頁表。
> 
> 透過這種方式，我們便實現了「按需建立」，避免浪費空間去維護那些未被使用的頁表區域。
>
>這同時也是典型的「時間與空間」權衡案例。
> 
> 採用雙層頁表架構時，若發生轉譯緩衝區（TLB）未命中（TLB miss）的情況，系統將需要執行三次記憶體存取：首先讀取第一層頁表，接著讀取第二層頁表，最後才能存取實體記憶體。
> 
> 雖然這意味著必須犧牲部分的 CPU 計算時間，但考慮到此機制能大幅節省記憶體空間，這種效能交換在整體效益上是非常划算的。

### TLB
因為頁表也是存在記憶體，如果都要從頁表找相當於每存取一次就要存取兩次記憶體。因此需要有快取。

TLB 是在 MMU 內部的關聯式記憶體。
- TLB Hit
- TLB Miss：去實體地址抓資料，並寫入 TLB。因為區域性原理你可能很快又會用到。

> [!question] 那考慮行程的上下文交換，我如何在 TLB 內區分不同行程的相同虛擬頁碼？
> 加上能辨識行程的獨特標籤。雖然直覺上我們會先聯想到 PID，畢竟這是較常接觸的概念，但在作業系統內部，硬體層面使用的是 ASID（Address Space ID）。ASID 是一種昂貴且稀缺的資源。相較於 PID 通常擁有 32 位元，ASID 可能僅有 8 或 16 位元。
> 
> 由於位元數較少（例如 8 位元僅能支援 256 個），當運行的程式數量超過上限時，ASID 就必須採取輪流使用的機制。這可以比喻為健身房的置物櫃：假設只有 256 個置物櫃，資源有限。你今天可能分配到 5 號櫃，但明天該櫃位可能就會轉分配給其他人。
> 
> 這兩者的區別在於：PID 就像是行程（Process）的身分證，會伴隨其整個生命週期；而 ASID 則是可變動的，僅用於在硬體層面臨時識別該行程。當行程被切換下來時，其佔用的 ASID 號碼便會釋放，供其他行程使用。
>
> |**虛擬頁號 (Page #)**|**物理頁框 (Frame #)**|**ASID (你的 PID 概念)**|
> |---|---|---|
> |0x01|0x55|**10** (Process A)|
> |0x01|0x99|**20** (Process B)| 
>
> 所以 TLB 其實長這樣
> - Entry 1: 虛擬頁 1 -> 實體頁 100 | **ASID: 10 (Process A)**
> - Entry 2: 虛擬頁 1 -> 實體頁 200 | **ASID: 20 (Process B)**