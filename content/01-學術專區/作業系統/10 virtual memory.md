---
title: Virtual Memory
draft: true
tags:
  - operating-system
date: 2025-12-06
---
這章節真的和 [[09 Main Memory]] 只有一線之隔。

在第九章中，我們利用邏輯虛擬頁來區分邏輯地址與實體地址。基於此基礎，我們可以進一步構建「虛擬記憶體（Virtual Memory）」。這項技術讓每個行程（Process）都誤以為自己擁有巨大的記憶體空間（例如 4GB），即便實際的實體記憶體並不足夠。由於行程運作具有局部性（Locality），通常不會同時用到所有資料，因此我們可以利用硬碟中一個獨特的區域——「置換空間（Swap Space）」，來儲存那些暫時不用的記憶體資料。

為了實現這個機制，我們在頁表（Page Table）中新增了一個控制標記：**Valid/Invalid Bit**。

- **Valid**：表示該頁面目前真的存在於實體記憶體中，可以直接存取。
- **Invalid**：表示該頁面不在記憶體中，而是位於硬碟的置換空間內。

當記憶體管理單元（MMU）發現目標頁面不在實體記憶體（即狀態為 Invalid）時，便無法取得對應的實體地址。由於記憶體本質上可視為硬碟的快取，且硬碟的讀取速度遠慢於記憶體，若 CPU 原地等待資料讀取將極無效率。因此，系統會將此情況判定為「分頁錯誤（Page Fault）」。此時，CPU 會先轉去執行其他任務，並將讀取資料的工作交由硬碟驅動程式（Disk Driver）處理；當資料讀取完畢後，作業系統會將檢索到的資料載入實體記憶體（RAM），並將頁表（Page Table）中的對應位元更新為 Valid。隨後，CPU 將重新執行先前導致分頁錯誤的指令；由於頁表資訊已更新，該指令此次將能順利執行。

![[assets/steps in handling page fault.png]]
# 頁面置換
當新的頁面需要載入時，若記憶體尚有空間，我們可直接將其寫入；但若記憶體已滿，就必須選定一個舊頁面將其移除，騰出空間給新頁面。這個「選擇犧牲者」的過程，正是頁面置換演算法（Page Replacement Algorithms）的核心職責。

理論上，最佳的策略是直接移除「未來最長時間內不會被使用」的頁面，因為這樣能將分頁錯誤（Page Fault）降至最低。然而，實際上我們無法預知未來，無法確認哪個頁面接下來不會被用到，因此需要參考其他替代方案：

1. 先進先出法（FIFO）：
    優先移除最早進入的頁面。但此法存在明顯缺陷，因為最早載入的通常是核心代碼或全域變數等常用資料，若將其移除，系統很快又需重新載入，影響效率。
2. 最近最少使用法（LRU）：
	利用歷史推測未來，移除長久未被使用的頁面。若某頁面許久未被存取，推測其未來被使用的機率也較低。但是要精確地實作 LRU 其實很耗硬體資源，你需要記錄每一個頁面最後一次被存取的時間點，還要排序。
	
為了在實務上更有效地實現 LRU 的概念，我們引入了「二次機會演算法（Second Chance Algorithm）」。其運作邏輯類似時鐘（因此也常被稱為時鐘演算法）：
- **資料結構**：將記憶體中的所有頁面排列成環狀。
- **運作機制**：指針依序檢查每個頁面的參照位元（Reference Bit）。
    - 若該頁面曾經被存取（Reference Bit 為 1），則給予它「二次機會」，將位元重置為 0，並檢查下一個頁面。
    - 若該頁面未被存取（Reference Bit 為 0），則將其替換掉。

透過這種機制，凡是最近被頻繁存取的頁面，其參照位元會被不斷刷新，從而避免被替換。這在很大程度上模擬了最佳化演算法的效果。
# 效能問題

當大量行程互相爭奪有限的頁框（Page Frame）時，由於實體資源有限且無法虛擬化，行程將頻繁發生分頁錯誤（Page Fault）。此時，CPU 必須等待硬碟讀取資料，導致 CPU 使用率顯著下降。若作業系統為了提升多工程度（Multiprogramming）而誤判情勢，載入更多行程，反而會加劇資源爭奪，導致系統陷入無限循環的效能崩潰，此現象稱為「震盪（Thrashing）」。

為解決此問題，主要有兩種策略：

1. 降低多工程度（利用中程排程器）
透過中程排程器（Medium Term Scheduler）強制介入，選擇並暫停部分行程，將它們佔用的頁框釋放出來，以緩解資源壓力。

2. 採用工作集模型（Working Set Model）
此模型主張依據行程需求動態分配頁框。由於不同行程在不同時間點的記憶體需求差異甚大（例如排序演算法與簡單的 I/O 操作需求不同），系統需持續監控行程在特定時間窗口內頻繁存取的頁面集合（即「工作集」）。

- 動態監控：隨著程式執行階段的改變（如初始化、運算、輸出），其工作集內容與大小（Working Set Size）也會隨之變動。
- 資源評估公式：
    設 $D$ 為所有行程工作集大小的總和（$\Sigma \text{Working Set Size}$），$M$ 為物理記憶體擁有的總頁框數。
	$$
	D = \Sigma{WSS_i}
	$$
    - 若 $D < M$：代表記憶體尚有餘裕，可載入新行程。
    - 若 $D > M$：代表即便僅滿足最低需求，資源仍不足。此時必須暫停部分行程（Swap out），直到 $D < M$。
- 實務應用：系統通常不會等到資源完全耗盡才處理，而是會設定上限與下限閾值（Upper/Lower Bound）來進行預防性管理。
# 內核記憶體分配
作業系統可以用連續記憶體分配（因為只會有一個內核）
- Buddy System
- Slab Allocation